<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Modifier la Commande</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: nav}"></div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3>Modifier la commande n°<span th:text="${commande.id}"></span></h3>
                </div>
                <div class="card-body">
                    <form th:action="@{/orders/edit/{id}(id=${commande.id})}" method="post">
                        <!-- Sélecteur de table (ne change pas) -->
                        <div class="mb-3">
                            <label for="table" class="form-label">Table</label>
                            <select id="table" name="tableId" class="form-select" required>
                                <option th:each="tableRestaurant : ${tables}"
                                        th:value="${tableRestaurant.identifiant}"
                                        th:text="'Table ' + ${tableRestaurant.numeroTable}"
                                        th:selected="${tableRestaurant.identifiant == commande.table.identifiant}"></option>
                            </select>
                        </div>

                        <!-- Affichage du client (ne change pas) -->
                        <div class="mb-3">
                            <label class="form-label">Client</label>
                            <input type="text" class="form-control" th:value="${commande.client.fullName}" readonly>
                        </div>

                        <div class="alert alert-info" th:if="${commande.etat.toString() != 'EN_ATTENTE'}">
                            Cette commande est déjà en cours. Les éléments sélectionnés ci-dessous seront <strong>ajoutés</strong> (ils ne remplaceront pas l'existant).
                        </div>

                        <!-- ========================================================== -->
                        <!--     MISE À JOUR AVEC LES 3 LISTES DE SÉLECTION           -->
                        <!-- ========================================================== -->
                        <div class="mb-3">
                            <label for="plats" class="form-label">Plats Cuisinés & Desserts</label>
                            <select id="plats" name="platIds" class="form-select" multiple size="8">
                                <option th:each="plat : ${platsCuisines}"
                                        th:value="${plat.identifiant}"
                                        th:text="${plat.nom}"
                                        th:selected="${commande.etat.toString() == 'EN_ATTENTE' and commande.lignesCommande.![plat != null ? plat.identifiant : null].contains(plat.identifiant)}"></option>
                            </select>
                            <small class="form-text text-muted">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs items.</small>
                        </div>

                        <div class="mb-3">
                            <label for="boissons" class="form-label">Boissons</label>
                            <select id="boissons" name="platIds" class="form-select" multiple size="5">
                                <option th:each="boisson : ${boissons}"
                                        th:value="${boisson.identifiant}"
                                        th:text="${boisson.nom}"
                                        th:selected="${commande.etat.toString() == 'EN_ATTENTE' and commande.lignesCommande.![plat != null ? plat.identifiant : null].contains(boisson.identifiant)}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="menus" class="form-label">Menus</label>
                            <select id="menus" name="menuIds" class="form-select" multiple size="5">
                                <option th:each="menu : ${menus}"
                                        th:value="${menu.id}"
                                        th:text="${menu.nom}"
                                        th:selected="${commande.etat.toString() == 'EN_ATTENTE' and commande.lignesCommande.![menu != null ? menu.id : null].contains(menu.id)}"></option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a th:href="@{/orders}" class="btn btn-secondary">Annuler</a>
                            <button type="submit" class="btn btn-primary">Enregistrer les Modifications</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>